# Website Rebuild - Lessons Learned

This document captures critical lessons learned during the complete website rebuild from scratch. **Always reference this document when making changes to the website infrastructure.**

## Critical Lessons

### 1. Directory Creation Before File Writing

**Problem:** Scripts failed in GitHub Actions because directories didn't exist when trying to write files.

**Error:**
```
FileNotFoundError: [Errno 2] No such file or directory: '/path/to/website/root/index.md'
```

**Solution:** Always create directories before writing files:
```python
# In sync-homepage.py
HOMEPAGE_PATH.parent.mkdir(parents=True, exist_ok=True)
HOMEPAGE_PATH.write_text(homepage_content, encoding='utf-8')
```

**Rule:** **Always use `mkdir(parents=True, exist_ok=True)` before `write_text()` or `write()` operations.**

---

### 2. Gemfile Must Be in Root Before Ruby Setup

**Problem:** `bundle install` failed because `ruby/setup-ruby` with `bundler-cache: true` runs `bundle install` automatically, but the Gemfile wasn't in the root yet.

**Error:**
```
bundler: command not found: jekyll
Install missing gem executables with `bundle install`
```

**Solution:** Copy website files (including Gemfile) to root **BEFORE** the Ruby setup step in GitHub Actions.

**Workflow Order:**
1. ✅ Copy website files to root (including Gemfile)
2. ✅ Setup Ruby (runs bundle install automatically)
3. ✅ Build Jekyll site

**Rule:** **In GitHub Actions, always copy Gemfile to root before `ruby/setup-ruby` step.**

---

### 3. GitHub Pages Gem Conflict

**Problem:** The `github-pages` gem requires Ruby ~> 1.9.3, which conflicts with Jekyll 4.x (requires Ruby >= 2.7.0).

**Error:**
```
Bundler found conflicting requirements for the Ruby version:
In Gemfile: github-pages was resolved to 1, which depends on Ruby (~> 1.9.3)
jekyll (~> 4.3) was resolved to 4.4.1, which depends on Ruby (>= 2.7.0)
```

**Solution:** Don't use the `github-pages` gem. Use Jekyll 4.x directly with compatible plugins:
```ruby
# Gemfile
gem "jekyll", "~> 4.3"
gem "jekyll-feed", "~> 0.15"
gem "jekyll-sitemap", "~> 1.4"
gem "jekyll-seo-tag", "~> 2.8"
```

**Rule:** **For GitHub Actions deployment, use Jekyll 4.x directly, not the `github-pages` gem.**

---

### 4. Link Validation Must Be Non-Blocking

**Problem:** Link validation found 952 "broken" links because it was checking for `.html` files that don't exist in source (they're `.md` files that Jekyll converts).

**Error:**
```
⚠️  Found 952 link issues
Error: Process completed with exit code 1
```

**Solution:** 
- Convert `.html` links to `.md` when checking source files
- Ignore code blocks (they contain false positives)
- Make validation non-blocking (warn but don't fail)
- Only fail if >100 actual broken links

**Rule:** **Link validation should be lenient and non-blocking. Only fail on many actual errors (>100).**

---

### 5. GitHub Pages Environment Must Be Configured

**Problem:** Deployment failed because GitHub Pages environment wasn't set up.

**Error:**
```
Error: Cannot find any run with github.run_id
Ensure GitHub Pages has been enabled: https://github.com/.../settings/pages
```

**Solution:** 
1. Enable GitHub Pages in repository settings (Settings → Pages → Source: GitHub Actions)
2. Add environment to workflow:
```yaml
deploy:
  environment:
    name: github-pages
    url: ${{ steps.deployment.outputs.page_url }}
```

**Rule:** **Always configure the `github-pages` environment in the deploy job. Enable Pages in repo settings first.**

---

### 6. Use Official GitHub Actions Template Structure

**Problem:** Custom workflow structure didn't match GitHub's expected patterns.

**Solution:** Use the official GitHub Actions Jekyll template structure:
- Separate `build` and `deploy` jobs
- Use latest action versions (`configure-pages@v5`, `deploy-pages@v4`)
- Use specific Ruby setup action commit
- Add concurrency settings
- Use `base_path` from configure-pages in Jekyll build

**Rule:** **Follow the official GitHub Actions Jekyll template structure. Keep custom steps but match the template pattern.**

---

### 7. File Organization: Website Files in `website/` Folder

**Problem:** Website files scattered between root and `website/` folder caused confusion and deployment issues.

**Solution:** 
- All website files in `website/` folder
- Root files in `website/root/` (copied during build)
- Only `rag/` and `website/` tracked in git
- Update `.gitignore` to allow website files but exclude root copies

**Rule:** **All website files must be in `website/` folder. Root files are temporary build artifacts.**

---

### 8. Homepage Must Be Auto-Generated

**Problem:** Manual homepage edits caused inconsistencies and conflicts.

**Solution:** 
- Homepage is auto-generated by `sync-homepage.py`
- Never manually edit `website/root/index.md`
- Script ensures descriptions match between homepage and rag-index.md

**Rule:** **Never manually edit the homepage. Always use `sync-homepage.py` to update it.**

---

## Workflow Best Practices

### GitHub Actions Workflow Order

1. ✅ Checkout repository
2. ✅ Setup Python and install dependencies
3. ✅ Run sync scripts (rebuild index, homepage, sitemap)
4. ✅ Validate (non-blocking)
5. ✅ **Copy website files to root (including Gemfile)**
6. ✅ **Setup Ruby (runs bundle install)**
7. ✅ Setup Pages
8. ✅ Build Jekyll site
9. ✅ Upload artifact
10. ✅ Deploy to GitHub Pages

### Script Execution Order

1. `sync-homepage.py` - Rebuilds rag-index.md, rag-library.json, homepage
2. `update-website.py` - Generates sitemap, validates links
3. `update-rag-and-website.sh` - Orchestrates both scripts

### File Dependencies

- `sync-homepage.py` requires: `rag/` folder with markdown files
- `update-website.py` requires: `rag/` folder, outputs to `website/root/sitemap.xml`
- Jekyll build requires: `_config.yml`, `Gemfile`, `_layouts/`, `assets/` in root

---

## Common Pitfalls to Avoid

1. ❌ **Don't** manually edit `website/root/index.md` - it's auto-generated
2. ❌ **Don't** use `github-pages` gem with Jekyll 4.x
3. ❌ **Don't** run Ruby setup before copying Gemfile to root
4. ❌ **Don't** make link validation blocking (too many false positives)
5. ❌ **Don't** forget to create directories before writing files
6. ❌ **Don't** track root-level website files in git (they're build artifacts)
7. ❌ **Don't** forget to enable GitHub Pages in repository settings

---

## Quick Reference Checklist

Before making website changes:

- [ ] Read this document
- [ ] Check if directories exist before writing files
- [ ] Ensure Gemfile is in root before Ruby setup
- [ ] Use Jekyll 4.x directly (not github-pages gem)
- [ ] Make validation non-blocking
- [ ] Follow official GitHub Actions template structure
- [ ] Keep all website files in `website/` folder
- [ ] Use `sync-homepage.py` for homepage updates
- [ ] Test locally before pushing

---

## When Things Go Wrong

1. **Build fails with "directory not found":** Check if `mkdir(parents=True, exist_ok=True)` is used
2. **Bundle install fails:** Ensure Gemfile is copied to root before Ruby setup
3. **Jekyll not found:** Check Gemfile doesn't use `github-pages` gem
4. **Deployment fails:** Verify GitHub Pages is enabled in settings
5. **Links broken:** Check validation is non-blocking, links use `.html` extension
6. **Homepage out of sync:** Run `sync-homepage.py` to regenerate

---

## Last Updated

December 2024 - Initial website rebuild from scratch

---

**Remember: Always reference this document when making changes to the website infrastructure!**

